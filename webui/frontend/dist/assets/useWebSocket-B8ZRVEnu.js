import{r,I as y}from"./index-CvNinI8u.js";let t=null;const n=r(!1),i=r(new Map),l=r(new Map),u=new Set,f=new Set,a=()=>{if(t&&t.readyState===WebSocket.OPEN)return;const e=y();if(!e){setTimeout(a,3e3);return}let s;s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`,s+=`?token=${encodeURIComponent(e)}`,t=new WebSocket(s),t.onopen=()=>{n.value=!0,t?.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic","relay.status"]})),u.forEach(o=>{t?.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic"],relay_id:o}))})},t.onclose=()=>{n.value=!1,t=null,setTimeout(a,3e3)},t.onerror=()=>{n.value=!1},t.onmessage=o=>{try{const c=JSON.parse(o.data);p(c),f.forEach(b=>b(c))}catch(c){console.error("WebSocket 消息解析失败",c)}}},p=e=>{switch(e.type){case"relay.connections":{const s=e.data;i.value.set(s.relay_id,s.connections||[]);break}case"relay.traffic":{const s=e.data;l.value.set(s.relay_id,s);break}}},d=e=>{u.add(e),t&&n.value&&t.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic"],relay_id:e}))},w=e=>{u.delete(e),t&&n.value&&t.send(JSON.stringify({action:"unsubscribe",relay_id:e})),i.value.delete(e),l.value.delete(e)},S=e=>{f.add(e)},k=e=>{f.delete(e)};a();function v(){return{connected:n,isConnected:n,connections:i,traffic:l,subscribe:d,unsubscribe:w,subscribeRelay:d,onMessage:S,offMessage:k}}export{v as u};
