import{d as ge,r as V,m as ye,B as be,o as ke,q as Ce,c as R,b as d,C as we,e as s,w as o,f as r,D as Ve,F as I,y as Re,G as f,E as i,H as N,h as u,u as Ue,g as b,n as E,t as k,l as he,v as O,_ as De}from"./index-X1O1lxeu.js";import{u as xe}from"./useWebSocket-BwddNcNk.js";const Ee={class:"dashboard-page"},Be={class:"page-header"},$e={class:"header-actions"},Se={key:0,class:"empty-state"},Pe={key:1,class:"cards-grid"},Ae={class:"card-header"},Me={class:"rule-name"},ze={class:"header-right"},Ie={class:"card-body"},Ne={class:"rule-info"},Oe={class:"value"},je={class:"rule-info"},Fe={class:"value"},Te=["onClick"],Le={class:"status-stats"},Je={class:"status-stats speed-in"},qe={class:"status-stats speed-out"},Ge={class:"card-footer"},We=ge({__name:"Dashboard",setup(He){const j=Ue(),h=V(!1),g=V([]),A=V(null),{traffic:F,subscribe:T,unsubscribe:L}=xe(),M=t=>{if(!t||t<=0)return"0 B/s";const e=1024,p=["B/s","KB/s","MB/s","GB/s"],l=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,l)).toFixed(1))+" "+p[l]},B=ye(()=>{const t={};for(const[e,p]of F.value.entries())t[e]={bytesInSpeed:p.bytes_in_speed||0,bytesOutSpeed:p.bytes_out_speed||0,connections:p.connections||0};return t}),J=t=>{j.push({path:"/monitor",query:{relay:t}})};be(()=>g.value,t=>{t.forEach(e=>{e.running&&T(e.id)})},{deep:!0});const C=V(!1),$=V("新建规则"),a=V({id:"",name:"",src:"",dst:"",protocol:"tcp"}),y=async()=>{h.value=!0;try{const t=await f.list();t.code===0?g.value=t.data||[]:i.error(t.msg)}finally{h.value=!1}},z=()=>{$.value="新建规则",a.value={id:"",name:"",src:"",dst:"",protocol:"tcp"},C.value=!0},q=t=>{$.value="编辑规则",a.value={id:t.id,name:t.name,src:t.src,dst:t.dst,protocol:t.protocol},C.value=!0},G=async()=>{if(!a.value.name||!a.value.src||!a.value.dst){i.error("请填写完整信息");return}try{let t;a.value.id?t=await f.update(a.value.id,a.value.name,a.value.src,a.value.dst,a.value.protocol):t=await f.create(a.value.name,a.value.src,a.value.dst,a.value.protocol),t.code===0?(i.success(a.value.id?"更新成功":"创建成功"),C.value=!1,y()):i.error(t.msg)}catch{i.error("操作失败")}},W=async t=>{try{await N.confirm("确定删除该规则?","提示",{type:"warning"});const e=await f.delete(t.id);e.code===0?(i.success("删除成功"),y()):i.error(e.msg)}catch{}},H=async t=>{const e=await f.start(t.id);e.code===0?(i.success("启动成功"),y()):i.error(e.msg)},K=async t=>{const e=await f.stop(t.id);e.code===0?(i.success("停止成功"),y()):i.error(e.msg)},Q=async()=>{const t=await f.startAll();t.code===0?(i.success("已启动所有启用的规则"),y()):i.error(t.msg)},X=async()=>{const t=await f.stopAll();t.code===0?(i.success("已停止所有规则"),y()):i.error(t.msg)},Y=async(t,e)=>{const p=await f.setEnabled(t.id,e);p.code===0?(t.enabled=e,!e&&t.running&&(t.running=!1)):i.error(p.msg)},Z=()=>g.value.some(t=>t.running),ee=()=>g.value.some(t=>t.enabled&&!t.running),te=t=>t==="both"?"TCP+UDP":t.toUpperCase(),se=async()=>{try{const t=await f.exportRules();if(t.code===0&&t.data){const e=t.data.map(_=>({name:_.name,src:_.src,dst:_.dst,protocol:_.protocol})),p=JSON.stringify(e,null,2),l=new Blob([p],{type:"application/json"}),c=URL.createObjectURL(l),m=document.createElement("a");m.href=c,m.download=`relay-rules-${new Date().toISOString().slice(0,10)}.json`,m.click(),URL.revokeObjectURL(c),i.success(`已导出 ${e.length} 条规则`)}else i.error(t.msg||"导出失败")}catch{i.error("导出失败")}},ne=()=>{A.value?.click()},oe=async t=>{const e=t.target,p=e.files?.[0];if(p)try{const l=await p.text(),c=JSON.parse(l);if(!Array.isArray(c)){i.error("无效的配置文件格式");return}const m=c.filter(v=>v&&typeof v.name=="string"&&typeof v.src=="string"&&typeof v.dst=="string");if(m.length===0){i.error("没有找到有效的规则");return}await N.confirm(`即将导入 ${m.length} 条规则，是否继续?`,"确认导入",{type:"info"});const _=await f.importRules(m);if(_.code===0){const v=_.data,U=v?.created??m.length,D=v?.skipped??0;D>0?i.success(`导入完成: 新增 ${U} 条, 跳过 ${D} 条 (监听地址已存在)`):i.success(`成功导入 ${U} 条规则`),y()}else i.error(_.msg||"导入失败")}catch(l){if(!(l==="cancel"||l&&typeof l=="object"&&l.action==="cancel")){console.error("导入错误:",l);const m=l instanceof SyntaxError?"JSON 格式错误":"导入失败";i.error(m)}}finally{e.value=""}};return ke(()=>{y()}),Ce(()=>{g.value.forEach(t=>{t.running&&L(t.id)})}),(t,e)=>{const p=r("VideoPlay"),l=r("el-icon"),c=r("el-button"),m=r("VideoPause"),_=r("el-divider"),v=r("Upload"),U=r("Download"),D=r("Plus"),le=r("DocumentAdd"),ae=r("Connection"),ie=r("el-tag"),de=r("el-switch"),re=r("User"),ce=r("Right"),ue=r("Edit"),pe=r("Delete"),S=r("el-input"),x=r("el-form-item"),P=r("el-radio"),me=r("el-radio-group"),fe=r("el-form"),_e=r("el-dialog"),ve=Ve("loading");return b(),R("div",Ee,[d("input",{ref_key:"importInput",ref:A,type:"file",accept:".json",style:{display:"none"},onChange:oe},null,544),d("div",Be,[e[11]||(e[11]=d("h3",null,"转发规则",-1)),d("div",$e,[s(c,{type:"success",disabled:!ee(),onClick:Q},{default:o(()=>[s(l,null,{default:o(()=>[s(p)]),_:1}),e[6]||(e[6]=u(" 全部开始 ",-1))]),_:1},8,["disabled"]),s(c,{type:"warning",disabled:!Z(),onClick:X},{default:o(()=>[s(l,null,{default:o(()=>[s(m)]),_:1}),e[7]||(e[7]=u(" 全部停止 ",-1))]),_:1},8,["disabled"]),s(_,{direction:"vertical"}),s(c,{onClick:ne},{default:o(()=>[s(l,null,{default:o(()=>[s(v)]),_:1}),e[8]||(e[8]=u(" 导入 ",-1))]),_:1}),s(c,{onClick:se,disabled:g.value.length===0},{default:o(()=>[s(l,null,{default:o(()=>[s(U)]),_:1}),e[9]||(e[9]=u(" 导出 ",-1))]),_:1},8,["disabled"]),s(c,{type:"primary",onClick:z},{default:o(()=>[s(l,null,{default:o(()=>[s(D)]),_:1}),e[10]||(e[10]=u(" 新建规则 ",-1))]),_:1})])]),!h.value&&g.value.length===0?(b(),R("div",Se,[s(l,{class:"empty-icon"},{default:o(()=>[s(le)]),_:1}),e[13]||(e[13]=d("p",null,"暂无转发规则",-1)),s(c,{type:"primary",onClick:z},{default:o(()=>[...e[12]||(e[12]=[u("创建第一条规则",-1)])]),_:1})])):we((b(),R("div",Pe,[(b(!0),R(I,null,Re(g.value,n=>(b(),R("div",{key:n.id,class:E(["rule-card",{"card-running":n.running,"card-disabled":!n.enabled}])},[d("div",Ae,[d("div",Me,[s(l,null,{default:o(()=>[s(ae)]),_:1}),d("span",null,k(n.name),1)]),d("div",ze,[s(ie,{type:n.protocol==="tcp"?"primary":n.protocol==="udp"?"success":"warning",size:"small"},{default:o(()=>[u(k(te(n.protocol)),1)]),_:2},1032,["type"]),s(de,{"model-value":n.enabled,size:"small",disabled:n.running,title:n.running?"运行中无法禁用":n.enabled?"点击禁用":"点击启用",onChange:w=>Y(n,w)},null,8,["model-value","disabled","title","onChange"])])]),d("div",Ie,[d("div",Ne,[e[14]||(e[14]=d("span",{class:"label"},"监听",-1)),d("span",Oe,k(n.src),1)]),d("div",je,[e[15]||(e[15]=d("span",{class:"label"},"目标",-1)),d("span",Fe,k(n.dst),1)]),d("div",{class:E(["rule-status",{clickable:n.running}]),onClick:w=>n.running&&J(n.id)},[d("span",{class:E(["status-indicator",n.running?"running":"stopped"])},null,2),d("span",{class:E(["status-text",n.running?"running":"stopped"])},k(n.running?"运行中":"已停止"),3),n.running?(b(),R(I,{key:0},[e[16]||(e[16]=d("span",{class:"status-divider"},"|",-1)),d("span",Le,[s(l,null,{default:o(()=>[s(re)]),_:1}),u(" "+k(B.value[n.id]?.connections||0),1)]),d("span",Je,[s(l,null,{default:o(()=>[s(U)]),_:1}),u(" "+k(M(B.value[n.id]?.bytesInSpeed||0)),1)]),d("span",qe,[s(l,null,{default:o(()=>[s(v)]),_:1}),u(" "+k(M(B.value[n.id]?.bytesOutSpeed||0)),1)]),s(l,{class:"monitor-link"},{default:o(()=>[s(ce)]),_:1})],64)):he("",!0)],10,Te)]),d("div",Ge,[n.running?(b(),O(c,{key:1,type:"warning",size:"small",onClick:w=>K(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(m)]),_:1}),e[18]||(e[18]=u(" 停止 ",-1))]),_:1},8,["onClick"])):(b(),O(c,{key:0,type:"success",size:"small",disabled:!n.enabled,title:n.enabled?"":"请先启用此规则",onClick:w=>H(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(p)]),_:1}),e[17]||(e[17]=u(" 启动 ",-1))]),_:1},8,["disabled","title","onClick"])),s(c,{type:"primary",size:"small",onClick:w=>q(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(ue)]),_:1}),e[19]||(e[19]=u(" 编辑 ",-1))]),_:1},8,["onClick"]),s(c,{type:"danger",size:"small",disabled:n.running,onClick:w=>W(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(pe)]),_:1}),e[20]||(e[20]=u(" 删除 ",-1))]),_:1},8,["disabled","onClick"])])],2))),128))])),[[ve,h.value]]),s(_e,{modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=n=>C.value=n),title:$.value,width:"480px"},{footer:o(()=>[s(c,{onClick:e[4]||(e[4]=n=>C.value=!1)},{default:o(()=>[...e[24]||(e[24]=[u("取消",-1)])]),_:1}),s(c,{type:"primary",onClick:G},{default:o(()=>[...e[25]||(e[25]=[u("确定",-1)])]),_:1})]),default:o(()=>[s(fe,{model:a.value,"label-width":"80px"},{default:o(()=>[s(x,{label:"名称"},{default:o(()=>[s(S,{modelValue:a.value.name,"onUpdate:modelValue":e[0]||(e[0]=n=>a.value.name=n),placeholder:"例如: Web服务器"},null,8,["modelValue"])]),_:1}),s(x,{label:"协议"},{default:o(()=>[s(me,{modelValue:a.value.protocol,"onUpdate:modelValue":e[1]||(e[1]=n=>a.value.protocol=n)},{default:o(()=>[s(P,{value:"tcp"},{default:o(()=>[...e[21]||(e[21]=[u("仅 TCP",-1)])]),_:1}),s(P,{value:"udp"},{default:o(()=>[...e[22]||(e[22]=[u("仅 UDP",-1)])]),_:1}),s(P,{value:"both"},{default:o(()=>[...e[23]||(e[23]=[u("TCP + UDP",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(x,{label:"监听地址"},{default:o(()=>[s(S,{modelValue:a.value.src,"onUpdate:modelValue":e[2]||(e[2]=n=>a.value.src=n),placeholder:"例如: 0.0.0.0:8080"},null,8,["modelValue"])]),_:1}),s(x,{label:"目标地址"},{default:o(()=>[s(S,{modelValue:a.value.dst,"onUpdate:modelValue":e[3]||(e[3]=n=>a.value.dst=n),placeholder:"例如: 192.168.1.100:80"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Xe=De(We,[["__scopeId","data-v-69f7871d"]]);export{Xe as default};
