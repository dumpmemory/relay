import{d as Ce,r as b,A as we,o as Ve,m as he,c as h,b as d,B as xe,e as s,w as o,f as r,C as De,F as T,t as Se,D as f,E as i,G as j,x as u,u as Ue,g as k,n as R,y as C,q as Re,p as F,_ as Ee}from"./index-CvNinI8u.js";import{u as Me}from"./useWebSocket-B8ZRVEnu.js";const Be={class:"dashboard-page"},Ie={class:"page-header"},$e={class:"header-actions"},Pe={key:0,class:"empty-state"},Ae={key:1,class:"cards-grid"},Oe={class:"card-header"},ze={class:"rule-name"},Ne={class:"header-right"},Te={class:"card-body"},je={class:"rule-info"},Fe={class:"value"},Le={class:"rule-info"},Je={class:"value"},qe=["onClick"],Ge={class:"status-stats"},We={class:"status-stats speed-in"},Ke={class:"status-stats speed-out"},He={class:"card-footer"},Qe=Ce({__name:"Dashboard",setup(Xe){const L=Ue(),D=b(!1),g=b([]),A=b(null),{traffic:J,subscribe:q,unsubscribe:G}=Me(),E=b(new Map),O=b(new Map);let M=null;const W=()=>{g.value.forEach(t=>{if(!t.running)return;const e=J.value.get(t.id),p=O.value.get(t.id);if(e&&p){const l=Math.max(0,e.bytes_in-p.bytes_in),c=Math.max(0,e.bytes_out-p.bytes_out);E.value.set(t.id,{bytesInSpeed:l,bytesOutSpeed:c,connections:e.connections})}else e&&E.value.set(t.id,{bytesInSpeed:0,bytesOutSpeed:0,connections:e.connections});e&&O.value.set(t.id,{...e})})},z=t=>{if(t===0)return"0 B/s";const e=1024,p=["B/s","KB/s","MB/s","GB/s"],l=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,l)).toFixed(1))+" "+p[l]},B=t=>E.value.get(t)||{bytesInSpeed:0,bytesOutSpeed:0,connections:0},K=t=>{L.push({path:"/monitor",query:{relay:t}})};we(()=>g.value,t=>{t.forEach(e=>{e.running&&q(e.id)})},{deep:!0});const w=b(!1),I=b("新建规则"),a=b({id:"",name:"",src:"",dst:"",protocol:"tcp"}),y=async()=>{D.value=!0;try{const t=await f.list();t.code===0?g.value=t.data||[]:i.error(t.msg)}finally{D.value=!1}},N=()=>{I.value="新建规则",a.value={id:"",name:"",src:"",dst:"",protocol:"tcp"},w.value=!0},H=t=>{I.value="编辑规则",a.value={id:t.id,name:t.name,src:t.src,dst:t.dst,protocol:t.protocol},w.value=!0},Q=async()=>{if(!a.value.name||!a.value.src||!a.value.dst){i.error("请填写完整信息");return}try{let t;a.value.id?t=await f.update(a.value.id,a.value.name,a.value.src,a.value.dst,a.value.protocol):t=await f.create(a.value.name,a.value.src,a.value.dst,a.value.protocol),t.code===0?(i.success(a.value.id?"更新成功":"创建成功"),w.value=!1,y()):i.error(t.msg)}catch{i.error("操作失败")}},X=async t=>{try{await j.confirm("确定删除该规则?","提示",{type:"warning"});const e=await f.delete(t.id);e.code===0?(i.success("删除成功"),y()):i.error(e.msg)}catch{}},Y=async t=>{const e=await f.start(t.id);e.code===0?(i.success("启动成功"),y()):i.error(e.msg)},Z=async t=>{const e=await f.stop(t.id);e.code===0?(i.success("停止成功"),y()):i.error(e.msg)},ee=async()=>{const t=await f.startAll();t.code===0?(i.success("已启动所有启用的规则"),y()):i.error(t.msg)},te=async()=>{const t=await f.stopAll();t.code===0?(i.success("已停止所有规则"),y()):i.error(t.msg)},se=async(t,e)=>{const p=await f.setEnabled(t.id,e);p.code===0?(t.enabled=e,!e&&t.running&&(t.running=!1)):i.error(p.msg)},ne=()=>g.value.some(t=>t.running),oe=()=>g.value.some(t=>t.enabled&&!t.running),le=t=>t==="both"?"TCP+UDP":t.toUpperCase(),ae=async()=>{try{const t=await f.exportRules();if(t.code===0&&t.data){const e=t.data.map(_=>({name:_.name,src:_.src,dst:_.dst,protocol:_.protocol})),p=JSON.stringify(e,null,2),l=new Blob([p],{type:"application/json"}),c=URL.createObjectURL(l),m=document.createElement("a");m.href=c,m.download=`relay-rules-${new Date().toISOString().slice(0,10)}.json`,m.click(),URL.revokeObjectURL(c),i.success(`已导出 ${e.length} 条规则`)}else i.error(t.msg||"导出失败")}catch{i.error("导出失败")}},ie=()=>{A.value?.click()},de=async t=>{const e=t.target,p=e.files?.[0];if(p)try{const l=await p.text(),c=JSON.parse(l);if(!Array.isArray(c)){i.error("无效的配置文件格式");return}const m=c.filter(v=>v&&typeof v.name=="string"&&typeof v.src=="string"&&typeof v.dst=="string");if(m.length===0){i.error("没有找到有效的规则");return}await j.confirm(`即将导入 ${m.length} 条规则，是否继续?`,"确认导入",{type:"info"});const _=await f.importRules(m);if(_.code===0){const v=_.data,x=v?.created??m.length,S=v?.skipped??0;S>0?i.success(`导入完成: 新增 ${x} 条, 跳过 ${S} 条 (监听地址已存在)`):i.success(`成功导入 ${x} 条规则`),y()}else i.error(_.msg||"导入失败")}catch(l){if(!(l==="cancel"||l&&typeof l=="object"&&l.action==="cancel")){console.error("导入错误:",l);const m=l instanceof SyntaxError?"JSON 格式错误":"导入失败";i.error(m)}}finally{e.value=""}};return Ve(()=>{y(),M=window.setInterval(W,1e3)}),he(()=>{M&&clearInterval(M),g.value.forEach(t=>{t.running&&G(t.id)})}),(t,e)=>{const p=r("VideoPlay"),l=r("el-icon"),c=r("el-button"),m=r("VideoPause"),_=r("el-divider"),v=r("Upload"),x=r("Download"),S=r("Plus"),re=r("DocumentAdd"),ce=r("Connection"),ue=r("el-tag"),pe=r("el-switch"),me=r("User"),fe=r("Right"),_e=r("Edit"),ve=r("Delete"),$=r("el-input"),U=r("el-form-item"),P=r("el-radio"),ge=r("el-radio-group"),ye=r("el-form"),be=r("el-dialog"),ke=De("loading");return k(),h("div",Be,[d("input",{ref_key:"importInput",ref:A,type:"file",accept:".json",style:{display:"none"},onChange:de},null,544),d("div",Ie,[e[11]||(e[11]=d("h3",null,"转发规则",-1)),d("div",$e,[s(c,{type:"success",disabled:!oe(),onClick:ee},{default:o(()=>[s(l,null,{default:o(()=>[s(p)]),_:1}),e[6]||(e[6]=u(" 全部开始 ",-1))]),_:1},8,["disabled"]),s(c,{type:"warning",disabled:!ne(),onClick:te},{default:o(()=>[s(l,null,{default:o(()=>[s(m)]),_:1}),e[7]||(e[7]=u(" 全部停止 ",-1))]),_:1},8,["disabled"]),s(_,{direction:"vertical"}),s(c,{onClick:ie},{default:o(()=>[s(l,null,{default:o(()=>[s(v)]),_:1}),e[8]||(e[8]=u(" 导入 ",-1))]),_:1}),s(c,{onClick:ae,disabled:g.value.length===0},{default:o(()=>[s(l,null,{default:o(()=>[s(x)]),_:1}),e[9]||(e[9]=u(" 导出 ",-1))]),_:1},8,["disabled"]),s(c,{type:"primary",onClick:N},{default:o(()=>[s(l,null,{default:o(()=>[s(S)]),_:1}),e[10]||(e[10]=u(" 新建规则 ",-1))]),_:1})])]),!D.value&&g.value.length===0?(k(),h("div",Pe,[s(l,{class:"empty-icon"},{default:o(()=>[s(re)]),_:1}),e[13]||(e[13]=d("p",null,"暂无转发规则",-1)),s(c,{type:"primary",onClick:N},{default:o(()=>[...e[12]||(e[12]=[u("创建第一条规则",-1)])]),_:1})])):xe((k(),h("div",Ae,[(k(!0),h(T,null,Se(g.value,n=>(k(),h("div",{key:n.id,class:R(["rule-card",{"card-running":n.running,"card-disabled":!n.enabled}])},[d("div",Oe,[d("div",ze,[s(l,null,{default:o(()=>[s(ce)]),_:1}),d("span",null,C(n.name),1)]),d("div",Ne,[s(ue,{type:n.protocol==="tcp"?"primary":n.protocol==="udp"?"success":"warning",size:"small"},{default:o(()=>[u(C(le(n.protocol)),1)]),_:2},1032,["type"]),s(pe,{"model-value":n.enabled,size:"small",disabled:n.running,title:n.running?"运行中无法禁用":n.enabled?"点击禁用":"点击启用",onChange:V=>se(n,V)},null,8,["model-value","disabled","title","onChange"])])]),d("div",Te,[d("div",je,[e[14]||(e[14]=d("span",{class:"label"},"监听",-1)),d("span",Fe,C(n.src),1)]),d("div",Le,[e[15]||(e[15]=d("span",{class:"label"},"目标",-1)),d("span",Je,C(n.dst),1)]),d("div",{class:R(["rule-status",{clickable:n.running}]),onClick:V=>n.running&&K(n.id)},[d("span",{class:R(["status-indicator",n.running?"running":"stopped"])},null,2),d("span",{class:R(["status-text",n.running?"running":"stopped"])},C(n.running?"运行中":"已停止"),3),n.running?(k(),h(T,{key:0},[e[16]||(e[16]=d("span",{class:"status-divider"},"|",-1)),d("span",Ge,[s(l,null,{default:o(()=>[s(me)]),_:1}),u(" "+C(B(n.id).connections),1)]),d("span",We,[s(l,null,{default:o(()=>[s(x)]),_:1}),u(" "+C(z(B(n.id).bytesInSpeed)),1)]),d("span",Ke,[s(l,null,{default:o(()=>[s(v)]),_:1}),u(" "+C(z(B(n.id).bytesOutSpeed)),1)]),s(l,{class:"monitor-link"},{default:o(()=>[s(fe)]),_:1})],64)):Re("",!0)],10,qe)]),d("div",He,[n.running?(k(),F(c,{key:1,type:"warning",size:"small",onClick:V=>Z(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(m)]),_:1}),e[18]||(e[18]=u(" 停止 ",-1))]),_:1},8,["onClick"])):(k(),F(c,{key:0,type:"success",size:"small",disabled:!n.enabled,title:n.enabled?"":"请先启用此规则",onClick:V=>Y(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(p)]),_:1}),e[17]||(e[17]=u(" 启动 ",-1))]),_:1},8,["disabled","title","onClick"])),s(c,{type:"primary",size:"small",onClick:V=>H(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(_e)]),_:1}),e[19]||(e[19]=u(" 编辑 ",-1))]),_:1},8,["onClick"]),s(c,{type:"danger",size:"small",disabled:n.running,onClick:V=>X(n)},{default:o(()=>[s(l,null,{default:o(()=>[s(ve)]),_:1}),e[20]||(e[20]=u(" 删除 ",-1))]),_:1},8,["disabled","onClick"])])],2))),128))])),[[ke,D.value]]),s(be,{modelValue:w.value,"onUpdate:modelValue":e[5]||(e[5]=n=>w.value=n),title:I.value,width:"480px"},{footer:o(()=>[s(c,{onClick:e[4]||(e[4]=n=>w.value=!1)},{default:o(()=>[...e[24]||(e[24]=[u("取消",-1)])]),_:1}),s(c,{type:"primary",onClick:Q},{default:o(()=>[...e[25]||(e[25]=[u("确定",-1)])]),_:1})]),default:o(()=>[s(ye,{model:a.value,"label-width":"80px"},{default:o(()=>[s(U,{label:"名称"},{default:o(()=>[s($,{modelValue:a.value.name,"onUpdate:modelValue":e[0]||(e[0]=n=>a.value.name=n),placeholder:"例如: Web服务器"},null,8,["modelValue"])]),_:1}),s(U,{label:"协议"},{default:o(()=>[s(ge,{modelValue:a.value.protocol,"onUpdate:modelValue":e[1]||(e[1]=n=>a.value.protocol=n)},{default:o(()=>[s(P,{value:"tcp"},{default:o(()=>[...e[21]||(e[21]=[u("仅 TCP",-1)])]),_:1}),s(P,{value:"udp"},{default:o(()=>[...e[22]||(e[22]=[u("仅 UDP",-1)])]),_:1}),s(P,{value:"both"},{default:o(()=>[...e[23]||(e[23]=[u("TCP + UDP",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(U,{label:"监听地址"},{default:o(()=>[s($,{modelValue:a.value.src,"onUpdate:modelValue":e[2]||(e[2]=n=>a.value.src=n),placeholder:"例如: 0.0.0.0:8080"},null,8,["modelValue"])]),_:1}),s(U,{label:"目标地址"},{default:o(()=>[s($,{modelValue:a.value.dst,"onUpdate:modelValue":e[3]||(e[3]=n=>a.value.dst=n),placeholder:"例如: 192.168.1.100:80"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),et=Ee(Qe,[["__scopeId","data-v-5e4bde7e"]]);export{et as default};
