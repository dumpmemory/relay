import{d as X,r as c,o as Y,C as Z,D as ee,c as x,b as e,e as o,w as l,f as n,l as K,t as I,j as _,h as v,E as d,g as S,I as se,_ as oe}from"./index-X1O1lxeu.js";const le={class:"settings-page"},ae={class:"settings-grid"},te={class:"setting-card"},ne={class:"card-header"},de={class:"card-icon"},re={class:"card-body"},ie={class:"form-group"},ce={class:"form-tip"},ue={class:"form-actions"},pe={class:"setting-card"},ve={class:"card-header"},fe={class:"card-icon"},me={class:"card-body"},_e={class:"form-group"},ge={class:"switch-row"},we={key:0,class:"switch-tip"},ye={class:"form-group"},he={key:0,class:"current-file"},be={class:"form-tip"},Pe={class:"setting-card"},ke={class:"card-header"},Ve={class:"card-icon"},Ce={class:"card-body"},xe={class:"form-group"},Ie={class:"form-group"},Se={class:"form-group"},De={class:"form-actions"},Re={class:"setting-card"},Ue={class:"card-header"},Ge={class:"card-icon recovery-icon"},Ke={class:"card-body"},Me={class:"form-group"},Le={class:"form-tip",style:{"margin-bottom":"12px","margin-top":"0"}},Fe={class:"form-actions"},Be={class:"dialog-key-display"},Oe={class:"dialog-footer"},ze=X({__name:"Settings",setup(Ee){const h=c(!1),g=c(!1),u=c(""),b=c(!1),w=c("*"),r=c({oldPassword:"",newPassword:"",confirmPassword:""}),f=c(""),P=c(!1),y=c(!1),k=c(""),D=async()=>{h.value=!0;try{const a=await _.getSettings();a.code===0&&(g.value=a.data.geoip_enabled==="true",u.value=a.data.geoip_file||"",w.value=a.data.cors_origin||"*")}finally{h.value=!1}},M=async()=>{const a=await _.updateSettings("cors_origin",w.value);a.code===0?d.success("CORS 设置已保存"):d.error(a.msg)},L=async a=>{const s=await _.updateSettings("geoip_enabled",String(a));s.code===0?d.success("设置已更新"):(d.error(s.msg),g.value=!a)},F=async a=>{if(!a.name.endsWith(".mmdb"))return d.error("请上传 .mmdb 格式的 GeoIP 数据库文件"),!1;b.value=!0;try{const s=new FormData;s.append("file",a.raw);const t=await(await fetch("/api/upload/geoip",{method:"POST",headers:{Authorization:se()},body:s})).json();t.code===0?(d.success("GeoIP 数据库上传成功"),u.value=a.name,D()):d.error(t.msg||"上传失败")}catch{d.error("上传失败")}finally{b.value=!1}return!1},B=async()=>{if(!r.value.oldPassword||!r.value.newPassword){d.error("请填写完整信息");return}if(r.value.newPassword!==r.value.confirmPassword){d.error("两次密码输入不一致");return}if(r.value.newPassword.length<6){d.error("密码长度至少 6 位");return}const a=await _.changePassword(r.value.oldPassword,r.value.newPassword);a.code===0?(d.success("密码修改成功"),r.value={oldPassword:"",newPassword:"",confirmPassword:""}):d.error(a.msg)},O=async()=>{if(!f.value){d.error("请输入当前密码");return}P.value=!0;try{const a=await _.regenerateRecoveryKey(f.value);a.code===0?(k.value=a.data.recovery_key,y.value=!0,f.value=""):d.error(a.msg)}finally{P.value=!1}},z=async()=>{try{await navigator.clipboard.writeText(k.value),d.success("已复制到剪贴板")}catch{d.error("复制失败，请手动复制")}};return Y(()=>{D()}),(a,s)=>{const R=n("Link"),t=n("el-icon"),m=n("el-input"),V=n("InfoFilled"),E=n("Check"),p=n("el-button"),N=n("Location"),T=n("el-switch"),j=n("Document"),A=n("SuccessFilled"),H=n("Upload"),W=n("el-upload"),C=n("Lock"),U=n("Unlock"),G=n("Key"),$=n("RefreshRight"),q=n("DocumentCopy"),J=n("el-dialog"),Q=ee("loading");return Z((S(),x("div",le,[s[28]||(s[28]=e("div",{class:"page-header"},[e("div",{class:"header-left"},[e("h3",null,"系统设置"),e("span",{class:"header-subtitle"},"管理系统配置和安全选项")])],-1)),e("div",ae,[e("div",te,[e("div",ne,[e("div",de,[o(t,null,{default:l(()=>[o(R)]),_:1})]),s[8]||(s[8]=e("div",{class:"card-title"},[e("h4",null,"跨域设置"),e("p",null,"CORS")],-1))]),e("div",re,[e("div",ie,[s[10]||(s[10]=e("label",{class:"form-label"},"允许的来源",-1)),o(m,{modelValue:w.value,"onUpdate:modelValue":s[0]||(s[0]=i=>w.value=i),placeholder:"* 表示允许所有，多个来源用逗号分隔",class:"dark-input"},null,8,["modelValue"]),e("div",ce,[o(t,null,{default:l(()=>[o(V)]),_:1}),s[9]||(s[9]=e("span",null,"示例：* 或 http://localhost:5173,https://example.com",-1))])]),e("div",ue,[o(p,{type:"primary",onClick:M},{default:l(()=>[o(t,null,{default:l(()=>[o(E)]),_:1}),s[11]||(s[11]=v(" 保存设置 ",-1))]),_:1})])])]),e("div",pe,[e("div",ve,[e("div",fe,[o(t,null,{default:l(()=>[o(N)]),_:1})]),s[12]||(s[12]=e("div",{class:"card-title"},[e("h4",null,"GeoIP 设置"),e("p",null,"IP 地理位置")],-1))]),e("div",me,[e("div",_e,[s[13]||(s[13]=e("label",{class:"form-label"},"启用 GeoIP",-1)),e("div",ge,[o(T,{modelValue:g.value,"onUpdate:modelValue":s[1]||(s[1]=i=>g.value=i),onChange:L,disabled:!u.value,class:"green-switch"},null,8,["modelValue","disabled"]),u.value?K("",!0):(S(),x("span",we,"需要先上传 GeoIP 数据库"))])]),e("div",ye,[s[15]||(s[15]=e("label",{class:"form-label"},"GeoIP 数据库",-1)),u.value?(S(),x("div",he,[o(t,null,{default:l(()=>[o(j)]),_:1}),e("span",null,I(u.value),1),o(t,{class:"file-status"},{default:l(()=>[o(A)]),_:1})])):K("",!0),o(W,{"auto-upload":!1,"show-file-list":!1,accept:".mmdb","on-change":F},{default:l(()=>[o(p,{loading:b.value},{default:l(()=>[o(t,null,{default:l(()=>[o(H)]),_:1}),v(" "+I(u.value?"更换文件":"上传 MMDB 文件"),1)]),_:1},8,["loading"])]),_:1}),e("div",be,[o(t,null,{default:l(()=>[o(V)]),_:1}),s[14]||(s[14]=e("span",null,"支持 MaxMind GeoLite2 或 GeoIP2 格式的 .mmdb 文件",-1))])])])]),e("div",Pe,[e("div",ke,[e("div",Ve,[o(t,null,{default:l(()=>[o(C)]),_:1})]),s[16]||(s[16]=e("div",{class:"card-title"},[e("h4",null,"修改密码"),e("p",null,"安全管理")],-1))]),e("div",Ce,[e("div",xe,[s[17]||(s[17]=e("label",{class:"form-label"},"当前密码",-1)),o(m,{modelValue:r.value.oldPassword,"onUpdate:modelValue":s[2]||(s[2]=i=>r.value.oldPassword=i),type:"password",placeholder:"请输入当前密码","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(C)]),_:1})]),_:1},8,["modelValue"])]),e("div",Ie,[s[18]||(s[18]=e("label",{class:"form-label"},"新密码",-1)),o(m,{modelValue:r.value.newPassword,"onUpdate:modelValue":s[3]||(s[3]=i=>r.value.newPassword=i),type:"password",placeholder:"请输入新密码 (至少 6 位)","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(U)]),_:1})]),_:1},8,["modelValue"])]),e("div",Se,[s[19]||(s[19]=e("label",{class:"form-label"},"确认新密码",-1)),o(m,{modelValue:r.value.confirmPassword,"onUpdate:modelValue":s[4]||(s[4]=i=>r.value.confirmPassword=i),type:"password",placeholder:"请再次输入新密码","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(U)]),_:1})]),_:1},8,["modelValue"])]),e("div",De,[o(p,{type:"primary",onClick:B},{default:l(()=>[o(t,null,{default:l(()=>[o(G)]),_:1}),s[20]||(s[20]=v(" 修改密码 ",-1))]),_:1})])])]),e("div",Re,[e("div",Ue,[e("div",Ge,[o(t,null,{default:l(()=>[o(G)]),_:1})]),s[21]||(s[21]=e("div",{class:"card-title"},[e("h4",null,"恢复密钥"),e("p",null,"密码重置")],-1))]),e("div",Ke,[e("div",Me,[e("div",Le,[o(t,null,{default:l(()=>[o(V)]),_:1}),s[22]||(s[22]=e("span",null,"恢复密钥可在忘记密码时重置密码，重新生成后旧密钥将失效",-1))]),s[23]||(s[23]=e("label",{class:"form-label"},"当前密码",-1)),o(m,{modelValue:f.value,"onUpdate:modelValue":s[5]||(s[5]=i=>f.value=i),type:"password",placeholder:"请输入当前密码以验证身份","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(C)]),_:1})]),_:1},8,["modelValue"])]),e("div",Fe,[o(p,{type:"warning",loading:P.value,onClick:O},{default:l(()=>[o(t,null,{default:l(()=>[o($)]),_:1}),s[24]||(s[24]=v(" 重新生成恢复密钥 ",-1))]),_:1},8,["loading"])])])])]),o(J,{modelValue:y.value,"onUpdate:modelValue":s[7]||(s[7]=i=>y.value=i),title:"新的恢复密钥",width:"480px","close-on-click-modal":!1,"close-on-press-escape":!1,class:"recovery-dialog"},{footer:l(()=>[e("div",Oe,[o(p,{onClick:z},{default:l(()=>[o(t,null,{default:l(()=>[o(q)]),_:1}),s[25]||(s[25]=v(" 复制密钥 ",-1))]),_:1}),o(p,{type:"primary",onClick:s[6]||(s[6]=i=>y.value=!1)},{default:l(()=>[...s[26]||(s[26]=[v(" 我已保存 ",-1)])]),_:1})])]),default:l(()=>[s[27]||(s[27]=e("div",{class:"dialog-warning"},[e("svg",{class:"dialog-warning-icon",viewBox:"0 0 20 20",fill:"currentColor"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})]),e("span",null,"请妥善保存，此密钥仅显示一次！旧密钥已失效。")],-1)),e("div",Be,[e("code",null,I(k.value),1)])]),_:1},8,["modelValue"])])),[[Q,h.value]])}}}),Te=oe(ze,[["__scopeId","data-v-481fce8b"]]);export{Te as default};
