import{r as l,I as g}from"./index-CYqpppIH.js";let t=null;const c=l(!1),y=l(!1);let d=null;const i=l(new Map),r=l(new Map),w=new Set,_=new Set,f=new Map,M=()=>{y.value=!0,d&&clearTimeout(d),d=window.setTimeout(()=>{y.value=!1},200)},p=()=>{if(t&&t.readyState===WebSocket.OPEN)return;const e=g();if(!e){setTimeout(p,3e3);return}let o;o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`,o+=`?token=${encodeURIComponent(e)}`,t=new WebSocket(o),t.onopen=()=>{c.value=!0,t?.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic","relay.status"]})),w.forEach(a=>{t?.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic"],relay_id:a}))})},t.onclose=()=>{c.value=!1,t=null,setTimeout(p,3e3)},t.onerror=()=>{c.value=!1},t.onmessage=a=>{try{const n=JSON.parse(a.data);S(n),M(),_.forEach(s=>s(n))}catch(n){console.error("WebSocket 消息解析失败",n)}}},S=e=>{switch(e.type){case"relay.connections":{const o=e.data,a=o.connections||[];a.forEach(s=>{const u=s.id,b=f.get(u);b&&s.active?(s.bytes_in_speed=Math.max(0,s.bytes_in-b.bytes_in),s.bytes_out_speed=Math.max(0,s.bytes_out-b.bytes_out)):(s.bytes_in_speed=0,s.bytes_out_speed=0),s.active?f.set(u,{bytes_in:s.bytes_in,bytes_out:s.bytes_out}):f.delete(u)});const n=new Map(i.value);n.set(o.relay_id,a),i.value=n;break}case"relay.traffic":{const o=e.data,a=new Map(r.value);a.set(o.relay_id,o),r.value=a;break}}},v=e=>{w.add(e),t&&c.value&&t.send(JSON.stringify({action:"subscribe",topics:["relay.connections","relay.traffic"],relay_id:e}))},k=e=>{w.delete(e),t&&c.value&&t.send(JSON.stringify({action:"unsubscribe",relay_id:e})),i.value.delete(e),r.value.delete(e)},m=e=>{_.add(e)},h=e=>{_.delete(e)};p();function O(){return{connected:c,isConnected:c,dataActive:y,connections:i,traffic:r,subscribe:v,unsubscribe:k,subscribeRelay:v,onMessage:m,offMessage:h}}export{O as u};
