import{d as Q,r as B,m as D,o as X,q as Y,c as r,b as t,C as Z,n as b,x as V,t as i,D as tt,e,w as l,f as _,l as x,F as T,y as st,G as et,p as ot,E as at,h as f,g as u,_ as lt}from"./index-X1O1lxeu.js";import{u as nt}from"./useWebSocket-BwddNcNk.js";const it={class:"monitor-page"},ct={class:"page-header"},dt={class:"header-right"},_t={class:"status-text"},rt={class:"monitor-layout"},ut={class:"relay-sidebar"},vt={class:"sidebar-header"},pt={class:"relay-list"},ft={key:0,class:"empty-list"},ht=["onClick"],mt={class:"relay-icon"},yt={class:"relay-info"},bt={class:"relay-name"},wt={class:"relay-addr"},gt={key:0,class:"relay-active"},kt={class:"monitor-content"},Mt={class:"stats-grid"},Ct={class:"stat-card stat-connections"},Bt={class:"stat-icon"},Dt={class:"stat-info"},xt={class:"stat-value"},Tt={class:"stat-card stat-speed-in"},Rt={class:"stat-icon"},Ft={class:"stat-info"},Lt={class:"stat-value"},Vt={class:"stat-card stat-speed-out"},$t={class:"stat-icon"},Nt={class:"stat-info"},Ut={class:"stat-value"},qt={class:"stat-card stat-in"},zt={class:"stat-icon"},Et={class:"stat-info"},Gt={class:"stat-value"},It={class:"stat-card stat-out"},Kt={class:"stat-icon"},St={class:"stat-info"},Wt={class:"stat-value"},At={class:"connections-panel"},jt={class:"panel-header"},Ht={class:"panel-title"},Jt={class:"panel-count"},Ot={class:"table-container"},Pt={class:"location-text"},Qt={class:"speed-badge speed-in"},Xt={class:"speed-badge speed-out"},Yt={key:1,class:"speed-inactive"},Zt={key:0,class:"empty-table"},ts={key:1,class:"empty-state"},ss={class:"empty-icon"},es=Q({__name:"Monitor",setup(os){const $=ot(),p=B([]),d=B(""),w=B(!1),{connections:N,traffic:U,subscribe:q,unsubscribe:R,isConnected:F}=nt(),g=D(()=>d.value?[...N.value.get(d.value)||[]].sort((s,c)=>s.active!==c.active?s.active?-1:1:new Date(c.started_at).getTime()-new Date(s.started_at).getTime()):[]),L={relay_id:"",bytes_in:0,bytes_out:0,bytes_in_speed:0,bytes_out_speed:0,connections:0},h=D(()=>d.value&&U.value.get(d.value)||L),z=D(()=>p.value.find(o=>o.id===d.value)),m=o=>{if(!o||o===0)return"0 B";const s=1024,c=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(o)/Math.log(s));return parseFloat((o/Math.pow(s,n)).toFixed(2))+" "+c[n]},y=o=>{if(!o||o<=0)return"0 B/s";const s=1024,c=["B/s","KB/s","MB/s","GB/s"],n=Math.floor(Math.log(o)/Math.log(s));return parseFloat((o/Math.pow(s,n)).toFixed(1))+" "+c[n]},E=o=>o?new Date(o).toLocaleTimeString():"-",G=o=>{if(!o||o===0)return"0s";if(o<60)return`${o}s`;if(o<3600)return`${Math.floor(o/60)}m ${o%60}s`;const s=Math.floor(o/3600),c=Math.floor(o%3600/60);return`${s}h ${c}m`},I=({row:o})=>o.active?"row-active":"row-inactive",K=async()=>{w.value=!0;try{const o=await et.list();if(o.code===0){p.value=(o.data||[]).filter(c=>c.running);const s=$.query.relay;s&&p.value.find(c=>c.id===s)?k(s):p.value[0]&&!d.value&&k(p.value[0].id)}else at.error(o.msg)}finally{w.value=!1}},k=o=>{d.value&&R(d.value),d.value=o,o&&q(o)};return X(()=>{K()}),Y(()=>{d.value&&R(d.value)}),(o,s)=>{const c=_("Connection"),n=_("el-icon"),S=_("VideoPause"),W=_("Check"),A=_("Link"),M=_("Download"),C=_("Upload"),j=_("List"),v=_("el-table-column"),H=_("el-table"),J=_("DocumentDelete"),O=_("Monitor",!0),P=tt("loading");return u(),r("div",it,[t("div",ct,[s[1]||(s[1]=t("div",{class:"header-left"},[t("h3",null,"实时监控"),t("span",{class:"header-subtitle"},"WebSocket 实时数据流")],-1)),t("div",dt,[t("div",{class:b(["ws-status",{connected:V(F)}])},[s[0]||(s[0]=t("span",{class:"status-dot"},null,-1)),t("span",_t,i(V(F)?"已连接":"未连接"),1)],2)])]),Z((u(),r("div",rt,[t("div",ut,[t("div",vt,[e(n,null,{default:l(()=>[e(c)]),_:1}),s[2]||(s[2]=t("span",null,"运行中的规则",-1))]),t("div",pt,[p.value.length===0?(u(),r("div",ft,[e(n,null,{default:l(()=>[e(S)]),_:1}),s[3]||(s[3]=t("p",null,"暂无运行中的规则",-1))])):x("",!0),(u(!0),r(T,null,st(p.value,a=>(u(),r("div",{key:a.id,class:b(["relay-item",{active:d.value===a.id}]),onClick:as=>k(a.id)},[t("div",mt,[e(n,null,{default:l(()=>[e(c)]),_:1})]),t("div",yt,[t("div",bt,i(a.name),1),t("div",wt,i(a.src),1)]),d.value===a.id?(u(),r("div",gt,[e(n,null,{default:l(()=>[e(W)]),_:1})])):x("",!0)],10,ht))),128))])]),t("div",kt,[z.value?(u(),r(T,{key:0},[t("div",Mt,[t("div",Ct,[t("div",Bt,[e(n,null,{default:l(()=>[e(A)]),_:1})]),t("div",Dt,[s[4]||(s[4]=t("div",{class:"stat-label"},"当前连接",-1)),t("div",xt,i(h.value.connections),1)])]),t("div",Tt,[t("div",Rt,[e(n,null,{default:l(()=>[e(M)]),_:1})]),t("div",Ft,[s[5]||(s[5]=t("div",{class:"stat-label"},"入站速度",-1)),t("div",Lt,i(y(h.value.bytes_in_speed)),1)])]),t("div",Vt,[t("div",$t,[e(n,null,{default:l(()=>[e(C)]),_:1})]),t("div",Nt,[s[6]||(s[6]=t("div",{class:"stat-label"},"出站速度",-1)),t("div",Ut,i(y(h.value.bytes_out_speed)),1)])]),t("div",qt,[t("div",zt,[e(n,null,{default:l(()=>[e(M)]),_:1})]),t("div",Et,[s[7]||(s[7]=t("div",{class:"stat-label"},"入站总量",-1)),t("div",Gt,i(m(h.value.bytes_in)),1)])]),t("div",It,[t("div",Kt,[e(n,null,{default:l(()=>[e(C)]),_:1})]),t("div",St,[s[8]||(s[8]=t("div",{class:"stat-label"},"出站总量",-1)),t("div",Wt,i(m(h.value.bytes_out)),1)])])]),t("div",At,[t("div",jt,[t("div",Ht,[e(n,null,{default:l(()=>[e(j)]),_:1}),s[9]||(s[9]=t("span",null,"连接记录",-1))]),t("div",Jt,i(g.value.length)+" 条",1)]),t("div",Ot,[e(H,{data:g.value,"row-class-name":I,"header-cell-class-name":"table-header-cell",class:"monitor-table",height:"100%"},{default:l(()=>[e(v,{prop:"active",label:"状态",width:"70"},{default:l(({row:a})=>[t("span",{class:b(["status-tag",a.active?"active":"inactive"])},i(a.active?"活跃":"断开"),3)]),_:1}),e(v,{prop:"protocol",label:"协议",width:"60"},{default:l(({row:a})=>[t("span",{class:b(["protocol-tag",a.protocol||"tcp"])},i((a.protocol||"tcp").toUpperCase()),3)]),_:1}),e(v,{prop:"client_ip",label:"客户端 IP","min-width":"140","show-overflow-tooltip":""}),e(v,{prop:"client_location",label:"位置",width:"100","show-overflow-tooltip":""},{default:l(({row:a})=>[t("span",Pt,i(a.client_location||"-"),1)]),_:1}),e(v,{prop:"started_at",label:"开始时间",width:"90"},{default:l(({row:a})=>[f(i(E(a.started_at)),1)]),_:1}),e(v,{prop:"duration",label:"时长",width:"80","show-overflow-tooltip":""},{default:l(({row:a})=>[f(i(G(a.duration)),1)]),_:1}),e(v,{prop:"bytes_in",label:"入站",width:"90","show-overflow-tooltip":""},{default:l(({row:a})=>[f(i(m(a.bytes_in)),1)]),_:1}),e(v,{prop:"bytes_out",label:"出站",width:"90","show-overflow-tooltip":""},{default:l(({row:a})=>[f(i(m(a.bytes_out)),1)]),_:1}),e(v,{label:"速度",width:"140","show-overflow-tooltip":""},{default:l(({row:a})=>[a.active?(u(),r(T,{key:0},[t("span",Qt,[e(n,null,{default:l(()=>[e(M)]),_:1}),f(" "+i(y(a.bytes_in_speed)),1)]),t("span",Xt,[e(n,null,{default:l(()=>[e(C)]),_:1}),f(" "+i(y(a.bytes_out_speed)),1)])],64)):(u(),r("span",Yt,"-"))]),_:1})]),_:1},8,["data"]),g.value.length===0?(u(),r("div",Zt,[e(n,null,{default:l(()=>[e(J)]),_:1}),s[10]||(s[10]=t("p",null,"暂无连接记录",-1))])):x("",!0)])])],64)):(u(),r("div",ts,[t("div",ss,[e(n,null,{default:l(()=>[e(O)]),_:1})]),s[11]||(s[11]=t("p",null,"请从左侧选择一个运行中的规则",-1))]))])])),[[P,w.value]])])}}}),is=lt(es,[["__scopeId","data-v-63d79cf3"]]);export{is as default};
