import{d as O,r as k,k as C,o as Q,m as X,c as u,b as t,B as Y,n as h,H as T,y as l,C as Z,e as o,w as n,f as r,q as D,F as R,t as tt,D as et,l as st,E as ot,x as m,g as _,_ as at}from"./index-trtxiWIY.js";import{u as nt}from"./useWebSocket-td5KHTF3.js";const lt={class:"monitor-page"},it={class:"page-header"},ct={class:"header-right"},dt={class:"status-text"},rt={class:"monitor-layout"},ut={class:"relay-sidebar"},_t={class:"sidebar-header"},vt={class:"relay-list"},pt={key:0,class:"empty-list"},ft=["onClick"],ht={class:"relay-icon"},mt={class:"relay-info"},yt={class:"relay-name"},bt={class:"relay-addr"},wt={key:0,class:"relay-active"},gt={class:"monitor-content"},kt={class:"stats-grid"},Ct={class:"stat-card stat-connections"},Dt={class:"stat-icon"},Mt={class:"stat-info"},Bt={class:"stat-value"},xt={class:"stat-card stat-in"},Tt={class:"stat-icon"},Rt={class:"stat-info"},Lt={class:"stat-value"},Vt={class:"stat-card stat-out"},$t={class:"stat-icon"},Nt={class:"stat-info"},Ft={class:"stat-value"},St={class:"connections-panel"},Ut={class:"panel-header"},qt={class:"panel-title"},Et={class:"panel-count"},It={class:"table-container"},Pt={class:"location-text"},zt={key:0,class:"empty-table"},Wt={key:1,class:"empty-state"},At={class:"empty-icon"},Gt=O({__name:"Monitor",setup(Ht){const L=st(),p=k([]),i=k(""),y=k(!1),{connections:V,traffic:$,subscribe:N,unsubscribe:M,isConnected:B}=nt(),b=C(()=>i.value?[...V.value.get(i.value)||[]].sort((e,c)=>e.active!==c.active?e.active?-1:1:new Date(c.started_at).getTime()-new Date(e.started_at).getTime()):[]),x={relay_id:"",bytes_in:0,bytes_out:0,connections:0},w=C(()=>i.value&&$.value.get(i.value)||x),F=C(()=>p.value.find(s=>s.id===i.value)),f=s=>{if(!s||s===0)return"0 B";const e=1024,c=["B","KB","MB","GB","TB"],d=Math.floor(Math.log(s)/Math.log(e));return parseFloat((s/Math.pow(e,d)).toFixed(2))+" "+c[d]},S=s=>s?new Date(s).toLocaleTimeString():"-",U=s=>{if(!s||s===0)return"0s";if(s<60)return`${s}s`;if(s<3600)return`${Math.floor(s/60)}m ${s%60}s`;const e=Math.floor(s/3600),c=Math.floor(s%3600/60);return`${e}h ${c}m`},q=({row:s})=>s.active?"row-active":"row-inactive",E=async()=>{y.value=!0;try{const s=await et.list();if(s.code===0){p.value=(s.data||[]).filter(c=>c.running);const e=L.query.relay;e&&p.value.find(c=>c.id===e)?g(e):p.value[0]&&!i.value&&g(p.value[0].id)}else ot.error(s.msg)}finally{y.value=!1}},g=s=>{i.value&&M(i.value),i.value=s,s&&N(s)};return Q(()=>{E()}),X(()=>{i.value&&M(i.value)}),(s,e)=>{const c=r("Connection"),d=r("el-icon"),I=r("VideoPause"),P=r("Check"),z=r("Link"),W=r("Download"),A=r("Upload"),G=r("List"),v=r("el-table-column"),H=r("el-table"),K=r("DocumentDelete"),j=r("Monitor",!0),J=Z("loading");return _(),u("div",lt,[t("div",it,[e[1]||(e[1]=t("div",{class:"header-left"},[t("h3",null,"实时监控"),t("span",{class:"header-subtitle"},"WebSocket 实时数据流")],-1)),t("div",ct,[t("div",{class:h(["ws-status",{connected:T(B)}])},[e[0]||(e[0]=t("span",{class:"status-dot"},null,-1)),t("span",dt,l(T(B)?"已连接":"未连接"),1)],2)])]),Y((_(),u("div",rt,[t("div",ut,[t("div",_t,[o(d,null,{default:n(()=>[o(c)]),_:1}),e[2]||(e[2]=t("span",null,"运行中的规则",-1))]),t("div",vt,[p.value.length===0?(_(),u("div",pt,[o(d,null,{default:n(()=>[o(I)]),_:1}),e[3]||(e[3]=t("p",null,"暂无运行中的规则",-1))])):D("",!0),(_(!0),u(R,null,tt(p.value,a=>(_(),u("div",{key:a.id,class:h(["relay-item",{active:i.value===a.id}]),onClick:Kt=>g(a.id)},[t("div",ht,[o(d,null,{default:n(()=>[o(c)]),_:1})]),t("div",mt,[t("div",yt,l(a.name),1),t("div",bt,l(a.src),1)]),i.value===a.id?(_(),u("div",wt,[o(d,null,{default:n(()=>[o(P)]),_:1})])):D("",!0)],10,ft))),128))])]),t("div",gt,[F.value?(_(),u(R,{key:0},[t("div",kt,[t("div",Ct,[t("div",Dt,[o(d,null,{default:n(()=>[o(z)]),_:1})]),t("div",Mt,[e[4]||(e[4]=t("div",{class:"stat-label"},"当前连接",-1)),t("div",Bt,l(w.value.connections),1)])]),t("div",xt,[t("div",Tt,[o(d,null,{default:n(()=>[o(W)]),_:1})]),t("div",Rt,[e[5]||(e[5]=t("div",{class:"stat-label"},"入站流量",-1)),t("div",Lt,l(f(w.value.bytes_in)),1)])]),t("div",Vt,[t("div",$t,[o(d,null,{default:n(()=>[o(A)]),_:1})]),t("div",Nt,[e[6]||(e[6]=t("div",{class:"stat-label"},"出站流量",-1)),t("div",Ft,l(f(w.value.bytes_out)),1)])])]),t("div",St,[t("div",Ut,[t("div",qt,[o(d,null,{default:n(()=>[o(G)]),_:1}),e[7]||(e[7]=t("span",null,"连接记录",-1))]),t("div",Et,l(b.value.length)+" 条",1)]),t("div",It,[o(H,{data:b.value,"row-class-name":q,"header-cell-class-name":"table-header-cell",class:"monitor-table","max-height":"400"},{default:n(()=>[o(v,{prop:"active",label:"状态",width:"70"},{default:n(({row:a})=>[t("span",{class:h(["status-tag",a.active?"active":"inactive"])},l(a.active?"活跃":"断开"),3)]),_:1}),o(v,{prop:"protocol",label:"协议",width:"60"},{default:n(({row:a})=>[t("span",{class:h(["protocol-tag",a.protocol||"tcp"])},l((a.protocol||"tcp").toUpperCase()),3)]),_:1}),o(v,{prop:"client_ip",label:"客户端 IP","min-width":"140","show-overflow-tooltip":""}),o(v,{prop:"client_location",label:"位置",width:"100","show-overflow-tooltip":""},{default:n(({row:a})=>[t("span",Pt,l(a.client_location||"-"),1)]),_:1}),o(v,{prop:"started_at",label:"开始时间",width:"90"},{default:n(({row:a})=>[m(l(S(a.started_at)),1)]),_:1}),o(v,{prop:"duration",label:"时长",width:"80","show-overflow-tooltip":""},{default:n(({row:a})=>[m(l(U(a.duration)),1)]),_:1}),o(v,{prop:"bytes_in",label:"入站",width:"100","show-overflow-tooltip":""},{default:n(({row:a})=>[m(l(f(a.bytes_in)),1)]),_:1}),o(v,{prop:"bytes_out",label:"出站",width:"100","show-overflow-tooltip":""},{default:n(({row:a})=>[m(l(f(a.bytes_out)),1)]),_:1})]),_:1},8,["data"]),b.value.length===0?(_(),u("div",zt,[o(d,null,{default:n(()=>[o(K)]),_:1}),e[8]||(e[8]=t("p",null,"暂无连接记录",-1))])):D("",!0)])])],64)):(_(),u("div",Wt,[t("div",At,[o(d,null,{default:n(()=>[o(j)]),_:1})]),e[9]||(e[9]=t("p",null,"请从左侧选择一个运行中的规则",-1))]))])])),[[J,y.value]])])}}}),Ot=at(Gt,[["__scopeId","data-v-0a1ee5e3"]]);export{Ot as default};
