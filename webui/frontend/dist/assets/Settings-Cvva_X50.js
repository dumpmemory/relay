import{d as K,r as u,o as R,C as j,D as q,c as h,b as s,e as o,w as l,f as n,q as S,z as x,i as f,t as P,g as b,E as r,I as W,_ as H}from"./index-CYqpppIH.js";const J={class:"settings-page"},Q={class:"settings-grid"},X={class:"setting-card"},Y={class:"card-header"},Z={class:"card-icon"},$={class:"card-body"},ss={class:"form-group"},es={class:"form-tip"},os={class:"form-actions"},ls={class:"setting-card"},as={class:"card-header"},ts={class:"card-icon"},ns={class:"card-body"},ds={class:"form-group"},rs={class:"switch-row"},is={key:0,class:"switch-tip"},cs={class:"form-group"},us={key:0,class:"current-file"},ps={class:"form-tip"},_s={class:"setting-card"},ms={class:"card-header"},fs={class:"card-icon"},vs={class:"card-body"},ws={class:"form-group"},gs={class:"form-group"},hs={class:"form-group"},Ps={class:"form-actions"},bs=K({__name:"Settings",setup(ys){const v=u(!1),p=u(!1),c=u(""),w=u(!1),_=u("*"),d=u({oldPassword:"",newPassword:"",confirmPassword:""}),y=async()=>{v.value=!0;try{const a=await f.getSettings();a.code===0&&(p.value=a.data.geoip_enabled==="true",c.value=a.data.geoip_file||"",_.value=a.data.cors_origin||"*")}finally{v.value=!1}},D=async()=>{const a=await f.updateSettings("cors_origin",_.value);a.code===0?r.success("CORS 设置已保存"):r.error(a.msg)},G=async a=>{const e=await f.updateSettings("geoip_enabled",String(a));e.code===0?r.success("设置已更新"):(r.error(e.msg),p.value=!a)},U=async a=>{if(!a.name.endsWith(".mmdb"))return r.error("请上传 .mmdb 格式的 GeoIP 数据库文件"),!1;w.value=!0;try{const e=new FormData;e.append("file",a.raw);const t=await(await fetch("/api/upload/geoip",{method:"POST",headers:{Authorization:W()},body:e})).json();t.code===0?(r.success("GeoIP 数据库上传成功"),c.value=a.name,y()):r.error(t.msg||"上传失败")}catch{r.error("上传失败")}finally{w.value=!1}return!1},L=async()=>{if(!d.value.oldPassword||!d.value.newPassword){r.error("请填写完整信息");return}if(d.value.newPassword!==d.value.confirmPassword){r.error("两次密码输入不一致");return}if(d.value.newPassword.length<6){r.error("密码长度至少 6 位");return}const a=await f.changePassword(d.value.oldPassword,d.value.newPassword);a.code===0?(r.success("密码修改成功"),d.value={oldPassword:"",newPassword:"",confirmPassword:""}):r.error(a.msg)};return R(()=>{y()}),(a,e)=>{const k=n("Link"),t=n("el-icon"),m=n("el-input"),V=n("InfoFilled"),F=n("Check"),g=n("el-button"),M=n("Location"),O=n("el-switch"),B=n("Document"),E=n("SuccessFilled"),N=n("Upload"),T=n("el-upload"),C=n("Lock"),I=n("Unlock"),z=n("Key"),A=q("loading");return j((b(),h("div",J,[e[18]||(e[18]=s("div",{class:"page-header"},[s("div",{class:"header-left"},[s("h3",null,"系统设置"),s("span",{class:"header-subtitle"},"管理系统配置和安全选项")])],-1)),s("div",Q,[s("div",X,[s("div",Y,[s("div",Z,[o(t,null,{default:l(()=>[o(k)]),_:1})]),e[5]||(e[5]=s("div",{class:"card-title"},[s("h4",null,"跨域设置"),s("p",null,"CORS")],-1))]),s("div",$,[s("div",ss,[e[7]||(e[7]=s("label",{class:"form-label"},"允许的来源",-1)),o(m,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=i=>_.value=i),placeholder:"* 表示允许所有，多个来源用逗号分隔",class:"dark-input"},null,8,["modelValue"]),s("div",es,[o(t,null,{default:l(()=>[o(V)]),_:1}),e[6]||(e[6]=s("span",null,"示例：* 或 http://localhost:5173,https://example.com",-1))])]),s("div",os,[o(g,{type:"primary",onClick:D},{default:l(()=>[o(t,null,{default:l(()=>[o(F)]),_:1}),e[8]||(e[8]=P(" 保存设置 ",-1))]),_:1})])])]),s("div",ls,[s("div",as,[s("div",ts,[o(t,null,{default:l(()=>[o(M)]),_:1})]),e[9]||(e[9]=s("div",{class:"card-title"},[s("h4",null,"GeoIP 设置"),s("p",null,"IP 地理位置")],-1))]),s("div",ns,[s("div",ds,[e[10]||(e[10]=s("label",{class:"form-label"},"启用 GeoIP",-1)),s("div",rs,[o(O,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=i=>p.value=i),onChange:G,disabled:!c.value,class:"green-switch"},null,8,["modelValue","disabled"]),c.value?S("",!0):(b(),h("span",is,"需要先上传 GeoIP 数据库"))])]),s("div",cs,[e[12]||(e[12]=s("label",{class:"form-label"},"GeoIP 数据库",-1)),c.value?(b(),h("div",us,[o(t,null,{default:l(()=>[o(B)]),_:1}),s("span",null,x(c.value),1),o(t,{class:"file-status"},{default:l(()=>[o(E)]),_:1})])):S("",!0),o(T,{"auto-upload":!1,"show-file-list":!1,accept:".mmdb","on-change":U},{default:l(()=>[o(g,{loading:w.value},{default:l(()=>[o(t,null,{default:l(()=>[o(N)]),_:1}),P(" "+x(c.value?"更换文件":"上传 MMDB 文件"),1)]),_:1},8,["loading"])]),_:1}),s("div",ps,[o(t,null,{default:l(()=>[o(V)]),_:1}),e[11]||(e[11]=s("span",null,"支持 MaxMind GeoLite2 或 GeoIP2 格式的 .mmdb 文件",-1))])])])]),s("div",_s,[s("div",ms,[s("div",fs,[o(t,null,{default:l(()=>[o(C)]),_:1})]),e[13]||(e[13]=s("div",{class:"card-title"},[s("h4",null,"修改密码"),s("p",null,"安全管理")],-1))]),s("div",vs,[s("div",ws,[e[14]||(e[14]=s("label",{class:"form-label"},"当前密码",-1)),o(m,{modelValue:d.value.oldPassword,"onUpdate:modelValue":e[2]||(e[2]=i=>d.value.oldPassword=i),type:"password",placeholder:"请输入当前密码","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(C)]),_:1})]),_:1},8,["modelValue"])]),s("div",gs,[e[15]||(e[15]=s("label",{class:"form-label"},"新密码",-1)),o(m,{modelValue:d.value.newPassword,"onUpdate:modelValue":e[3]||(e[3]=i=>d.value.newPassword=i),type:"password",placeholder:"请输入新密码 (至少 6 位)","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(I)]),_:1})]),_:1},8,["modelValue"])]),s("div",hs,[e[16]||(e[16]=s("label",{class:"form-label"},"确认新密码",-1)),o(m,{modelValue:d.value.confirmPassword,"onUpdate:modelValue":e[4]||(e[4]=i=>d.value.confirmPassword=i),type:"password",placeholder:"请再次输入新密码","show-password":"",class:"dark-input"},{prefix:l(()=>[o(t,null,{default:l(()=>[o(I)]),_:1})]),_:1},8,["modelValue"])]),s("div",Ps,[o(g,{type:"primary",onClick:L},{default:l(()=>[o(t,null,{default:l(()=>[o(z)]),_:1}),e[17]||(e[17]=P(" 修改密码 ",-1))]),_:1})])])])])])),[[A,v.value]])}}}),Vs=H(bs,[["__scopeId","data-v-8391db53"]]);export{Vs as default};
